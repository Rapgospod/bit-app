<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Bit Them All ‚Äî Tap Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg1:#0b0b0c;
      --bg2:#141417;
      --card:#1b1b1f;
      --muted:#a9a9b2;
      --accent:#00ff99;
      --warn:#ffcc00;
      --danger:#ff5b7a;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:#fff;
      background: radial-gradient(1200px 700px at 50% 0%, #1f1f25 0%, var(--bg1) 55%, #070708 100%);
      min-height:100vh;
      padding: 18px 16px 28px;
      display:flex;
      justify-content:center;
    }
    .wrap{ width:min(430px, 100%); }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .title{ font-size:18px; line-height:1.2; margin:0; font-weight:800; letter-spacing:.2px; }
    .sub{ margin:4px 0 0; color:var(--muted); font-size:12px; }

    .pill{
      padding:8px 10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 999px;
      font-size:12px;
      color:#e9e9f0;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      white-space:nowrap;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.09);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    .stats{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px; }
    .stat .label{ color:var(--muted); font-size:12px; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    .stat .value{ font-size:32px; font-weight:900; letter-spacing:.5px; }

    .mini{ font-size:12px; color:rgba(255,255,255,.78); margin-top:6px; }
    .mini b{ color:#fff; }

    .tapArea{ position:relative; overflow:hidden; padding: 14px; }
    .bunnyWrap{
      position:relative; width: 205px; height: 205px; margin: 6px auto 10px;
      display:grid; place-items:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .bunnyGlow{
      position:absolute; inset:-20px; border-radius:999px;
      background: radial-gradient(circle at 50% 50%, rgba(0,255,153,.24), rgba(0,255,153,.06), transparent 70%);
      filter: blur(2px);
      pointer-events:none;
      opacity:.95;
    }
    #bunny{
      width: 182px; height: 182px; object-fit:contain; border-radius: 26px;
      filter: drop-shadow(0 18px 36px rgba(0,0,0,.55));
      transform: translateZ(0);
      transition: transform .08s ease;
      will-change: transform;
    }
    .bunnyWrap:active #bunny{ transform: scale(0.97); }

    .shake{ animation: shake .22s ease; }
    @keyframes shake{
      0%{ transform: translateY(0) scale(1); }
      30%{ transform: translateY(-9px) scale(1.03); }
      65%{ transform: translateY(2px) scale(0.99); }
      100%{ transform: translateY(0) scale(1); }
    }

    .cta{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top: 8px; }
    .btn{
      background: var(--accent); color:#062014;
      border: none; border-radius: 14px;
      padding: 14px 16px;
      font-weight:900; font-size:15px;
      cursor:pointer;
      box-shadow: 0 16px 40px rgba(0,255,153,.18);
      min-width: 160px;
    }
    .btn:active{ transform: scale(0.98); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      color:#fff;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow:none;
      min-width: 120px;
      font-weight:800;
    }
    .btn.danger{
      background: rgba(255,91,122,.14);
      color: #ffd6de;
      border:1px solid rgba(255,91,122,.25);
      box-shadow:none;
      min-width:120px;
    }

    .energyLine{
      margin-top: 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: var(--muted); font-size:12px;
    }
    .bar{
      margin-top: 8px;
      height: 10px; border-radius:999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(0,255,153,.95), rgba(0,255,153,.55));
      border-radius:999px;
      transition: width .25s ease;
    }

    .toast{ margin-top:10px; font-size:12px; color: var(--warn); min-height: 16px; }

    /* floating */
    .float{
      position:absolute;
      font-weight: 900;
      font-size: 18px;
      pointer-events:none;
      opacity: 0;
      will-change: transform, opacity;
      animation: floatUp .85s ease forwards;
      text-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    @keyframes floatUp{
      0%{ opacity: 0; transform: translate(-50%, -10%) scale(.9); }
      18%{ opacity: 1; }
      100%{ opacity: 0; transform: translate(-50%, -160%) scale(1.2); }
    }

    .spark{
      position:absolute;
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(0,255,153,.85);
      pointer-events:none;
      opacity:.9;
      animation: spark .55s ease forwards;
      filter: blur(.2px);
    }
    @keyframes spark{
      0%{ transform: translate(-50%,-50%) scale(1); opacity:.95; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(.3); opacity:0; }
    }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:flex-end; justify-content:center;
      padding: 14px;
    }
    .modal{
      width:min(430px,100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(12px);
    }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .modalHead h2{ margin:0; font-size:16px; }
    .x{ border:none; background:transparent; color:#fff; font-size:22px; cursor:pointer; opacity:.8; }
    .shopItem{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      margin-top:10px;
    }
    .shopItem .left{ text-align:left; }
    .shopItem .name{ font-weight:900; }
    .shopItem .desc{ font-size:12px; color:var(--muted); margin-top:4px; }
    .buy{
      border:none; border-radius: 14px;
      padding: 10px 12px;
      font-weight:900;
      background: rgba(0,255,153,.14);
      color: var(--accent);
      border:1px solid rgba(0,255,153,.25);
      cursor:pointer;
      min-width: 98px;
    }
    .buy:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <p class="title" id="username">Welcome, Degen</p>
        <p class="sub">Combo ‚Ä¢ Crit ‚Ä¢ Daily ‚Ä¢ Upgrades</p>
      </div>
      <div class="pill" id="modePill">tg mini app</div>
    </div>

    <div class="stats">
      <div class="card stat">
        <div class="label">üí∞ BIT</div>
        <div class="value" id="balance">0</div>
        <div class="mini">Level: <b id="level">1</b> ‚Ä¢ XP: <b id="xp">0</b>/<b id="xpNeed">50</b></div>
      </div>
      <div class="card stat">
        <div class="label">‚ö° Energy</div>
        <div class="value"><span id="energy">10</span><span style="font-size:14px;color:var(--muted);font-weight:700"> /<span id="maxEnergy">10</span></span></div>
        <div class="mini">Regen: <b id="regenMs">3000</b>ms</div>
      </div>
    </div>

    <div class="card tapArea" id="tapArea">
      <div class="row">
        <div class="pill">üî• Combo: <b id="combo">x1</b></div>
        <div class="pill">üí• Crit: <b id="crit">10%</b></div>
        <div class="pill">üéÅ Daily: <b id="daily">ready</b></div>
      </div>

      <div class="bunnyWrap" id="bunnyWrap">
        <div class="bunnyGlow"></div>
        <img id="bunny"
             src="https://raw.githubusercontent.com/Rapgospod/bit-app/6b2bcc75348d5bc50380e7accb13a438d623d9db/pepebunny.png"
             alt="pepebunny" />
      </div>

      <div class="cta">
        <button class="btn" id="tapBtn">‚ö° TAP</button>
        <button class="btn secondary" id="shopBtn">üõí Shop</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>

      <div class="energyLine">
        <span>regen ticks</span>
        <span id="regenState">ready</span>
      </div>
      <div class="bar"><div id="energyBar"></div></div>

      <div class="toast" id="toast"></div>
      <div class="mini" style="margin-top:10px;color:rgba(255,255,255,.78)">
        –ë—ã—Å—Ç—Ä—ã–µ —Ç–∞–ø—ã –¥–∞—é—Ç Combo (–º–Ω–æ–∂–∏—Ç–µ–ª—å). –ò–Ω–æ–≥–¥–∞ –≤—ã–ø–∞–¥–∞–µ—Ç Crit (+5). Daily –±–æ–Ω—É—Å ‚Äî —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.
      </div>
    </div>
  </div>

  <!-- Shop Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h2>üõí Upgrades</h2>
        <button class="x" id="closeModal">√ó</button>
      </div>

      <div class="shopItem">
        <div class="left">
          <div class="name">‚ö° Max Energy +5</div>
          <div class="desc">–ë–æ–ª—å—à–µ —Å—Ç–∞–º–∏–Ω—ã = –±–æ–ª—å—à–µ –±–∏—Ç–æ–≤.</div>
        </div>
        <button class="buy" id="buyEnergy">Buy<br><span id="costEnergy">50</span></button>
      </div>

      <div class="shopItem">
        <div class="left">
          <div class="name">‚è± Regen faster</div>
          <div class="desc">–£–º–µ–Ω—å—à–∞–µ—Ç regen –Ω–∞ 300ms (–¥–æ –º–∏–Ω–∏–º—É–º–∞ 1200ms).</div>
        </div>
        <button class="buy" id="buyRegen">Buy<br><span id="costRegen">80</span></button>
      </div>

      <div class="shopItem">
        <div class="left">
          <div class="name">üí• Crit chance +5%</div>
          <div class="desc">–ß–∞—â–µ –≤—ã–ø–∞–¥–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–ø (+5 BIT).</div>
        </div>
        <button class="buy" id="buyCrit">Buy<br><span id="costCrit">120</span></button>
      </div>

      <div class="mini" style="margin-top:12px;color:rgba(255,255,255,.75)">
        –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞). –ü–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏–º —Ä–µ–π—Ç–∏–Ω–≥ —á–µ—Ä–µ–∑ –±–∞–∑—É.
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.expand();

    const user = tg?.initDataUnsafe?.user;
    const usernameEl = document.getElementById("username");
    usernameEl.textContent = "Welcome" + (user?.first_name ? ", " + user.first_name : ", Degen");

    const modePill = document.getElementById("modePill");
    modePill.textContent = tg ? "tg mini app" : "browser preview";

    // UI
    const balanceEl = document.getElementById("balance");
    const energyEl = document.getElementById("energy");
    const maxEnergyEl = document.getElementById("maxEnergy");
    const energyBar = document.getElementById("energyBar");
    const toast = document.getElementById("toast");
    const regenState = document.getElementById("regenState");
    const bunnyWrap = document.getElementById("bunnyWrap");
    const tapArea = document.getElementById("tapArea");
    const comboEl = document.getElementById("combo");
    const critEl = document.getElementById("crit");
    const dailyEl = document.getElementById("daily");
    const levelEl = document.getElementById("level");
    const xpEl = document.getElementById("xp");
    const xpNeedEl = document.getElementById("xpNeed");
    const regenMsEl = document.getElementById("regenMs");

    // modal
    const modalBack = document.getElementById("modalBack");
    const shopBtn = document.getElementById("shopBtn");
    const closeModal = document.getElementById("closeModal");

    const buyEnergyBtn = document.getElementById("buyEnergy");
    const buyRegenBtn  = document.getElementById("buyRegen");
    const buyCritBtn   = document.getElementById("buyCrit");

    const costEnergyEl = document.getElementById("costEnergy");
    const costRegenEl  = document.getElementById("costRegen");
    const costCritEl   = document.getElementById("costCrit");

    // GAME STATE (saved)
    const DEFAULT = {
      balance: 0,
      energy: 10,
      maxEnergy: 10,
      regenMs: 3000,
      critChance: 0.10, // 10%
      level: 1,
      xp: 0,
      lastTapAt: 0,
      combo: 1,
      comboEndsAt: 0,
      lastDailyAt: 0
    };

    function load(){
      try{
        const raw = localStorage.getItem("bta_state");
        return raw ? {...DEFAULT, ...JSON.parse(raw)} : {...DEFAULT};
      }catch(e){
        return {...DEFAULT};
      }
    }
    let S = load();

    function save(){
      localStorage.setItem("bta_state", JSON.stringify(S));
    }

    // costs (dynamic)
    function costs(){
      // —Ä–∞—Å—Ç—ë—Ç —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏
      const energyUp = Math.max(0, (S.maxEnergy - 10) / 5);
      const regenUp  = Math.max(0, Math.round((3000 - S.regenMs) / 300));
      const critUp   = Math.max(0, Math.round((S.critChance - 0.10) / 0.05));
      return {
        energy: 50 + energyUp * 40,
        regen:  80 + regenUp  * 55,
        crit:   120 + critUp  * 80,
      };
    }

    function xpNeed(level){
      return 50 + (level-1) * 25; // –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—è
    }

    function render(){
      balanceEl.textContent = S.balance;
      energyEl.textContent = S.energy;
      maxEnergyEl.textContent = S.maxEnergy;
      energyBar.style.width = `${(S.energy / S.maxEnergy) * 100}%`;

      comboEl.textContent = "x" + S.combo;
      critEl.textContent = Math.round(S.critChance * 100) + "%";

      const need = xpNeed(S.level);
      levelEl.textContent = S.level;
      xpEl.textContent = S.xp;
      xpNeedEl.textContent = need;

      regenMsEl.textContent = S.regenMs;

      // daily status
      const now = Date.now();
      const dayMs = 24*60*60*1000;
      const canDaily = (now - S.lastDailyAt) >= dayMs;
      dailyEl.textContent = canDaily ? "ready" : "cooldown";

      // shop costs
      const c = costs();
      costEnergyEl.textContent = c.energy;
      costRegenEl.textContent  = c.regen;
      costCritEl.textContent   = c.crit;

      // enable/disable buys
      buyEnergyBtn.disabled = S.balance < c.energy;
      buyRegenBtn.disabled  = S.balance < c.regen || S.regenMs <= 1200;
      buyCritBtn.disabled   = S.balance < c.crit  || S.critChance >= 0.50;
    }

    function showToast(msg){
      toast.textContent = msg || "";
      if (!msg) return;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.textContent="", 1100);
    }

    function vibrate(type="light"){
      try { tg?.HapticFeedback?.impactOccurred(type); } catch(e){}
      try { navigator.vibrate?.(type==="heavy"?25:15); } catch(e){}
    }

    function bunnyPop(){
      bunnyWrap.classList.remove("shake");
      void bunnyWrap.offsetWidth;
      bunnyWrap.classList.add("shake");
    }

    function floatText(x, y, text, color){
      const el = document.createElement("div");
      el.className = "float";
      el.textContent = text;
      el.style.color = color || "var(--accent)";

      const rect = tapArea.getBoundingClientRect();
      el.style.left = (x - rect.left) + "px";
      el.style.top  = (y - rect.top)  + "px";
      el.style.transform = "translate(-50%, -50%)";
      tapArea.appendChild(el);
      setTimeout(()=> el.remove(), 900);
    }

    function sparks(x, y){
      const rect = tapArea.getBoundingClientRect();
      const baseX = x - rect.left;
      const baseY = y - rect.top;
      const n = 6;
      for (let i=0;i<n;i++){
        const s = document.createElement("div");
        s.className = "spark";
        s.style.left = baseX + "px";
        s.style.top  = baseY + "px";
        const dx = (Math.random()*120 - 60).toFixed(0) + "px";
        const dy = (Math.random()*-120 - 30).toFixed(0) + "px";
        s.style.setProperty("--dx", dx);
        s.style.setProperty("--dy", dy);
        tapArea.appendChild(s);
        setTimeout(()=> s.remove(), 650);
      }
    }

    // combo system
    function updateCombo(now){
      const comboWindow = 900; // ms –º–µ–∂–¥—É —Ç–∞–ø–∞—é—â–∏–º–∏ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è combo
      if (now - S.lastTapAt <= comboWindow){
        // —Ä–∞—Å—Ç—ë–º –ø–ª–∞–≤–Ω–æ: –∫–∞–∂–¥—ã–µ 4 –±—ã—Å—Ç—Ä—ã—Ö —Ç–∞–ø–∞ +1 –º–Ω–æ–∂–∏—Ç–µ–ª—å
        // —Ö—Ä–∞–Ω–∏–º "comboEndsAt" —á—Ç–æ–±—ã combo –Ω–µ –ø–∞–¥–∞–ª –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
        // –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å: –ø–æ–≤—ã—à–∞—Ç—å —à–∞–Ω—Å–æ–º ‚Äî –Ω–æ —Ç–∞–∫ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ
      } else {
        S.combo = 1;
      }
      S.comboEndsAt = now + comboWindow;
    }

    function maybeIncreaseCombo(now){
      // —Å—á–∏—Ç–∞–µ–º —Å–µ—Ä–∏—é –±—ã—Å—Ç—Ä—ã—Ö —Ç–∞–ø–æ–≤
      // –∏—Å–ø–æ–ª—å–∑—É–µ–º xp –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—á—ë—Ç—á–∏–∫? –Ω–µ—Ç. —Å–¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –≤ –ø–∞–º—è—Ç–∏ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º)
      // –Ω–æ –º–æ–∂–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî –Ω–µ –≤–∞–∂–Ω–æ.
    }

    let fastStreak = 0;

    function tap(x, y){
      const now = Date.now();

      // combo decay
      if (now > S.comboEndsAt) {
        S.combo = 1;
        fastStreak = 0;
      }

      if (S.energy <= 0){
        showToast("No energy üòµ wait regen...");
        return;
      }

      // update combo based on speed
      const comboWindow = 900;
      if (now - S.lastTapAt <= comboWindow){
        fastStreak++;
        if (fastStreak % 4 === 0 && S.combo < 10){
          S.combo++;
          showToast("üî• Combo x" + S.combo);
          vibrate("light");
        }
      } else {
        fastStreak = 1;
        S.combo = 1;
      }
      S.lastTapAt = now;
      S.comboEndsAt = now + comboWindow;

      // crit
      const isCrit = Math.random() < S.critChance;
      const baseGain = isCrit ? 5 : 1;
      const gain = baseGain * S.combo;

      // spend energy
      S.energy -= 1;

      // earn
      S.balance += gain;

      // xp
      S.xp += gain;
      let need = xpNeed(S.level);
      while (S.xp >= need){
        S.xp -= need;
        S.level++;
        need = xpNeed(S.level);
        showToast("üÜô LEVEL UP: " + S.level);
        vibrate("heavy");
      }

      save();
      render();

      bunnyPop();
      sparks(x, y);
      floatText(x, y, `+${gain} BIT`, isCrit ? "var(--danger)" : "var(--accent)");
      vibrate(isCrit ? "heavy" : "light");
    }

    // daily bonus
    function tryDaily(){
      const now = Date.now();
      const dayMs = 24*60*60*1000;
      if ((now - S.lastDailyAt) < dayMs){
        showToast("Daily –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤ üéÅ");
        return;
      }
      const bonus = 25 + (S.level * 2);
      S.balance += bonus;
      S.lastDailyAt = now;
      save();
      render();
      showToast("üéÅ Daily +" + bonus + " BIT");
      vibrate("heavy");
    }

    // regen
    setInterval(()=>{
      if (S.energy < S.maxEnergy){
        S.energy += 1;
        save();
        render();
        regenState.textContent = "+1";
        setTimeout(()=> regenState.textContent="ready", 350);
      }
    }, () => S.regenMs);

    // IMPORTANT: interval above can't change dynamically via function in JS.
    // We'll run our own loop instead:
    let regenTimer = null;
    function startRegenLoop(){
      if (regenTimer) clearInterval(regenTimer);
      regenTimer = setInterval(()=>{
        if (S.energy < S.maxEnergy){
          S.energy += 1;
          save();
          render();
          regenState.textContent = "+1";
          setTimeout(()=> regenState.textContent="ready", 350);
        }
      }, S.regenMs);
    }

    // events
    document.getElementById("tapBtn").addEventListener("click", ()=>{
      const r = tapArea.getBoundingClientRect();
      tap(r.left + r.width/2, r.top + r.height*0.40);
    });

    bunnyWrap.addEventListener("click", (e)=> tap(e.clientX, e.clientY));
    bunnyWrap.addEventListener("touchstart", (e)=>{
      const t = e.touches?.[0];
      if (!t) return;
      tap(t.clientX, t.clientY);
    }, {passive:true});

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      if (!confirm("Reset progress?")) return;
      S = {...DEFAULT};
      save();
      fastStreak = 0;
      render();
      startRegenLoop();
      showToast("Reset ‚úÖ");
      try { tg?.HapticFeedback?.notificationOccurred("success"); } catch(e){}
    });

    // shop modal
    function openShop(){ modalBack.style.display = "flex"; }
    function closeShop(){ modalBack.style.display = "none"; }

    shopBtn.addEventListener("click", openShop);
    closeModal.addEventListener("click", closeShop);
    modalBack.addEventListener("click", (e)=>{
      if (e.target === modalBack) closeShop();
    });

    // buys
    buyEnergyBtn.addEventListener("click", ()=>{
      const c = costs().energy;
      if (S.balance < c) return;
      S.balance -= c;
      S.maxEnergy += 5;
      S.energy = Math.min(S.energy + 5, S.maxEnergy);
      save(); render();
      showToast("‚ö° Max energy upgraded!");
      vibrate("heavy");
      startRegenLoop();
    });

    buyRegenBtn.addEventListener("click", ()=>{
      const c = costs().regen;
      if (S.balance < c || S.regenMs <= 1200) return;
      S.balance -= c;
      S.regenMs = Math.max(1200, S.regenMs - 300);
      save(); render();
      showToast("‚è± Regen –±—ã—Å—Ç—Ä–µ–µ!");
      vibrate("heavy");
      startRegenLoop();
    });

    buyCritBtn.addEventListener("click", ()=>{
      const c = costs().crit;
      if (S.balance < c || S.critChance >= 0.50) return;
      S.balance -= c;
      S.critChance = Math.min(0.50, S.critChance + 0.05);
      save(); render();
      showToast("üí• Crit chance +5%");
      vibrate("heavy");
    });

    // daily click via pill
    document.querySelectorAll(".pill").forEach(p=>{
      if (p.textContent.includes("Daily")){
        p.style.cursor = "pointer";
        p.title = "Click for daily bonus";
        p.addEventListener("click", tryDaily);
      }
    });

    // init
    render();
    startRegenLoop();
    showToast("Tap! –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏ = combo üî•");

  </script>
</body>
</html>